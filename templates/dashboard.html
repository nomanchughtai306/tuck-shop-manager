{% extends "base.html" %}
{% block title %}Dashboard - Analytics & Insights{% endblock %}

{% block content %}
<!-- Dashboard Header with Date Filter -->
<header class="main-header" style="margin-bottom: 2rem;">
    <div class="panel-header" style="margin-bottom: 0;">
        <div>
            <h1 style="font-size: 1.875rem; font-weight: 700; margin-bottom: 0.25rem;">
                <span style="color: var(--accent);">ğŸ“Š</span> Dashboard
            </h1>
            <p style="color: var(--text-muted); font-size: 0.95rem;">Track your business performance & insights</p>
        </div>
        
        <form action="/" method="GET" class="date-filter-form">
            <div class="filter-inputs">
                <label for="d1" class="date-group">
                    <span class="label-text">From:</span>
                    <input id="d1" type="date" name="start_date" class="form-input d" value="{{ s_date }}" required>
                </label>
                <span class="filter-separator" style="color: var(--text-dim);">â†’</span>
                <label for="d2" class="date-group">
                    <span class="label-text">To:</span>
                    <input id="d2" type="date" name="end_date" class="form-input d" value="{{ e_date }}" required>
                </label>
            </div>
            <div class="filter-actions">
                <button type="submit" class="btn btn-primary">Analyze</button>
                <a href="/" class="btn btn-secondary">Reset</a>
            </div>
        </form>
    </div>
</header>

<!-- Stats Cards Row -->
<section class="stats-row">
    {% if analytics and analytics != 'empty' %}
    <!-- Total Revenue Card -->
    <div class="stat-card border-primary">
        <div class="stat-label">ğŸ’° Total Revenue</div>
        <div class="stat-value count-up" data-target="{{ analytics.total_revenue }}">PKR 0</div>
        <div class="stat-sub">From {{ analytics.total_sold }} units sold</div>
    </div>

    <!-- Net Profit Card -->
    <div class="stat-card border-accent">
        <div class="stat-label">ğŸ“ˆ Net Profit</div>
        <div class="stat-value count-up highlight-accent" data-target="{{ analytics.net_profit }}">PKR 0</div>
        <div class="stat-sub">Overall Earnings</div>
    </div>

    <!-- Most Profitable Product Card -->
    <div class="stat-card">
        <div class="stat-label">ğŸ† Most Profitable</div>
        <div class="stat-focus">{{ analytics.most_profitable.name }}</div>
        <div class="stat-sub accent-text">Generated PKR {{ "%.2f"|format(analytics.most_profitable.total_profit_generated) }}</div>
    </div>

    <!-- Highest Margin Card -->
    <div class="stat-card">
        <div class="stat-label">â­ Highest Margin</div>
        <div class="stat-focus">{{ analytics.highest_margin.name }}</div>
        <div class="stat-sub accent-text">+PKR {{ "%.2f"|format(analytics.highest_margin.profit_per_item) }} per unit</div>
    </div>
    {% else %}
    <!-- Empty State Cards -->
    <div class="stat-card">
        <div class="stat-label">ğŸ“Š Status</div>
        <div class="stat-value" style="font-size: 1.5rem;">No Data</div>
        <div class="stat-sub">Start adding products</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">ğŸ’° Revenue</div>
        <div class="stat-value">PKR 0</div>
        <div class="stat-sub">Sales will appear here</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">ğŸ“ˆ Profit</div>
        <div class="stat-value">PKR 0</div>
        <div class="stat-sub">Track your earnings</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">ğŸ“¦ Inventory</div>
        <div class="stat-value" style="font-size: 1.5rem;">Empty</div>
        <div class="stat-sub">Add products to start</div>
    </div>
    {% endif %}
</section>

<!-- Product Performance Section -->
<div class="panel">
    <span class="panel-title">ğŸ“¦ Individual Product Performance Breakdown</span>
    <div class="performance-grid">
        {% for product in products %}
        <div class="prod-card">
            <div class="prod-card-header">
                <strong>{{ product.name }}</strong>
                <span class="badge badge-success">PKR {{ "%.2f"|format(product.total_profit_generated) }} Profit</span>
            </div>
            <div class="prod-card-details">
                <span>ğŸ›’ {{ product.items_sold }} sold</span>
                <span>ğŸ’µ PKR {{ "%.2f"|format(product.items_sold * product.sale_price) }} revenue</span>
            </div>
            {% set percentage = (product.items_sold / product.quantity * 100) if product.quantity > 0 else 0 %}
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" data-width="{{ percentage }}"></div>
            </div>
            <small class="progress-label">{{ percentage|round|int }}% of stock sold</small>
        </div>
        {% else %}
        <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--text-muted);">
            <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“­</div>
            <h3 style="margin-bottom: 0.5rem;">No Products Yet</h3>
            <p>Add your first product to see performance analytics</p>
            <a href="{{ url_for('products') }}" class="btn btn-primary" style="margin-top: 1rem;">Add Product</a>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Quick Actions Panel -->
<div class="panel" style="background: linear-gradient(145deg, rgba(57, 255, 20, 0.05) 0%, rgba(15, 25, 15, 0.8) 100%);">
    <span class="panel-title">âš¡ Quick Actions</span>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <a href="{{ url_for('products') }}" class="btn btn-primary">
            <span>â•</span> Add Product
        </a>
        <a href="{{ url_for('loans') }}" class="btn btn-gold">
            <span>ğŸ’¸</span> New Loan
        </a>
        <a href="{{ url_for('rates') }}" class="btn btn-secondary">
            <span>ğŸ“Š</span> Check Rates
        </a>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Money Count-Up Animation
        const counters = document.querySelectorAll('.count-up');
        const animateValue = (obj, start, end, duration) => {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const value = progress * (end - start) + start;
                obj.innerHTML = 'PKR ' + value.toLocaleString(undefined, {
                    minimumFractionDigits: 2, maximumFractionDigits: 2
                });
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        };

        counters.forEach(counter => {
            const target = parseFloat(counter.getAttribute('data-target'));
            if (!isNaN(target)) animateValue(counter, 0, target, 1500);
        });

        // Progress Bar Animation
        const bars = document.querySelectorAll('.progress-bar-fill');
        setTimeout(() => {
            bars.forEach(bar => {
                const targetWidth = bar.getAttribute('data-width');
                bar.style.width = Math.min(targetWidth, 100) + '%';
            });
        }, 300);

        // Auto-hide Flash Messages
        const flashes = document.querySelectorAll('.flash-item');
        flashes.forEach(f => {
            setTimeout(() => {
                f.style.opacity = '0';
                f.style.transform = 'translateX(20px)';
                f.style.transition = 'all 0.5s ease';
                setTimeout(() => f.remove(), 500);
            }, 4000);
        });

        // Date Picker Helper
        document.querySelectorAll('.date-group').forEach(group => {
            group.addEventListener('click', function (e) {
                if (e.target.tagName !== 'INPUT') {
                    const input = this.querySelector('input[type="date"]');
                    if (input) {
                        try { input.showPicker(); } catch (err) { input.focus(); }
                    }
                }
            });
        });

        // Active Nav Item
        const currentPath = window.location.pathname;
        document.querySelectorAll('.nav-item').forEach(item => {
            if (item.getAttribute('href') === currentPath) {
                item.classList.add('active');
            }
        });
    });
    /* This ensures that if the user clicks anywhere on the label or 
       the input box itself, the browser's native date picker pops up.
    */
    document.querySelectorAll('input[type="date"]').forEach(input => {
        input.addEventListener('click', function() {
            this.showPicker();
        });
    });
</script>
{% endblock %}
